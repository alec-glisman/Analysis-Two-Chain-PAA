<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>colvar_parallel.base &mdash; Analysis Two Chain PAA v2.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Analysis Two Chain PAA
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../analysis_helpers.html">analysis_helpers package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../colvar_parallel.html">colvar_parallel package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../figures.html">figures package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stats.html">stats package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">utils package</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Key files:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../colvar_parallel.base.html">colvar_parallel.base module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../stats.block_error.html">stats.block_error module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">External links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://www.dask.org/get-started">Dask</a></li>
<li class="toctree-l1"><a class="reference external" href="https://userguide.mdanalysis.org/stable/examples/quickstart.html">MDAnalysis Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="https://userguide.mdanalysis.org/stable/examples/README.html">MDAnalysis Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.mdanalysis.org/stable/documentation_pages/analysis_modules.html">MDAnalysis Analysis Modules</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.plumed.org/doc-v2.8/user-doc/html/tutorials.html">Plumed Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Analysis Two Chain PAA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">colvar_parallel.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for colvar_parallel.base</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Author: Alec Glisman (GitHub: @alec-glisman)</span>
<span class="sd">Date: 2023-03-14</span>
<span class="sd">Description: Base class for parallel analysis</span>

<span class="sd">This module is a simple extension of MDAnalysis.analysis.base.AnalysisBase to</span>
<span class="sd">allow parallelization with dask and takes inspiration from the PMDA package.</span>
<span class="sd">Users should specify dask options using the new kwargs `n_jobs` and `n_blocks`.</span>
<span class="sd">The `n_jobs` argument specifies the number of jobs to start, if `-1` use number</span>
<span class="sd">of logical cpu cores. The `n_blocks` argument specifies the number of blocks to</span>
<span class="sd">split the trajectory into. If `None` use `n_jobs`.</span>

<span class="sd">All derived classes must implement the `_single_frame` method. This method</span>
<span class="sd">should return a `np.ndarray` instead of writing to a `self.results` list.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Standard library</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># External dependencies</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dask</span>

    <span class="n">FOUND_DASK</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FOUND_DASK</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">joblib</span>

    <span class="n">FOUND_JOBLIB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">FOUND_JOBLIB</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># MDAnalysis interface</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.analysis.base</span> <span class="kn">import</span> <span class="n">AnalysisBase</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.core.groups</span> <span class="kn">import</span> <span class="n">AtomGroup</span>
<span class="kn">from</span> <span class="nn">MDAnalysis.coordinates.base</span> <span class="kn">import</span> <span class="n">ReaderBase</span>

<span class="c1"># add local src directory to path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="s2">&quot;src&quot;</span><span class="p">))</span>

<span class="c1"># Local internal dependencies</span>
<span class="kn">from</span> <span class="nn">utils.logs</span> <span class="kn">import</span> <span class="n">setup_logging</span>  <span class="c1"># noqa: E402</span>


<div class="viewcode-block" id="ParallelAnalysisBase"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase">[docs]</a><span class="k">class</span> <span class="nc">ParallelAnalysisBase</span><span class="p">(</span><span class="n">AnalysisBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple extension of MDAnalysis.analysis.base.AnalysisBase to allow</span>
<span class="sd">    parallelization with dask. This class is not meant to be used</span>
<span class="sd">    directly, but rather as a base class for parallel analysis classes.</span>

<span class="sd">    Note that the `_single_frame` and `run` methods are overridden</span>
<span class="sd">    and require different arguments than the base class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trajectory</span><span class="p">:</span> <span class="n">ReaderBase</span><span class="p">,</span>
        <span class="n">atomgroups</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">AtomGroup</span><span class="p">],</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the analysis object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trajectory : :class:`~MDAnalysis.coordinates.base.ReaderBase`</span>
<span class="sd">            A trajectory reader.</span>
<span class="sd">        atomgroups : tuple[:class:`~MDAnalysis.core.groups.AtomGroup`]</span>
<span class="sd">            A tuple of atomgroups to be analyzed.</span>
<span class="sd">        label : str, optional</span>
<span class="sd">            A label for the data. Default: ``None``.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Turn on verbosity. Default: ``False``.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Other keyword arguments passed to the base class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># call base class constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># set up logging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">log_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;logs/</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># set MDA data structures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atomgroups</span> <span class="o">=</span> <span class="n">atomgroups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of atomgroups: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atomgroups</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_universe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atomgroups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">universe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trajectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universe</span><span class="o">.</span><span class="n">trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universe</span><span class="o">.</span><span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_universe</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">ag</span><span class="o">.</span><span class="n">indices</span> <span class="k">for</span> <span class="n">ag</span> <span class="ow">in</span> <span class="n">atomgroups</span><span class="p">]</span>

        <span class="c1"># external data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_weights</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tag: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># output data</span>
        <span class="c1"># REVIEW: These should be implemented in the derived classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dir_out</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ParallelAnalysisBase._prepare"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase._prepare">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the analysis class for the single frame analysis.</span>
<span class="sd">        This is called once before the analysis is started inside</span>
<span class="sd">        the run() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase._single_frame"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase._single_frame">[docs]</a>    <span class="k">def</span> <span class="nf">_single_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform computation on a single trajectory frame.</span>
<span class="sd">        Must return computed values as a list. You can only **read**</span>
<span class="sd">        from member variables stored in ``self``. Changing them during</span>
<span class="sd">        a run will result in undefined behavior. `ts` and any of the</span>
<span class="sd">        atomgroups can be changed (but changes will be overwritten</span>
<span class="sd">        when the next time step is read).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        idx_frame : int</span>
<span class="sd">            The index of the current frame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        values : anything</span>
<span class="sd">            The output from the computation over a single frame must</span>
<span class="sd">            be returned. The `value` will be added to a list for each</span>
<span class="sd">            block and the list of blocks is stored as :attr:`_results`</span>
<span class="sd">            before :meth:`_conclude` is run. In order to simplify</span>
<span class="sd">            processing, the `values` should be &quot;simple&quot; shallow data</span>
<span class="sd">            structures such as arrays or lists of numbers. It is easiest</span>
<span class="sd">            if the return value is a single array or list of numbers.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError</span>
<span class="sd">            If this method is not implemented in a subclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Override this method in your subclass&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase.run"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">frames</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;dask&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParallelAnalysisBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the calculation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : int, optional</span>
<span class="sd">            start frame of analysis</span>
<span class="sd">        stop : int, optional</span>
<span class="sd">            stop frame of analysis</span>
<span class="sd">        step : int, optional</span>
<span class="sd">            number of frames to skip between each analysed frame</span>
<span class="sd">        frames : array_like, optional</span>
<span class="sd">            array of integers or booleans to slice trajectory; `frames` can</span>
<span class="sd">            only be used *instead* of `start`, `stop`, and `step`. Setting</span>
<span class="sd">            *both* `frames` and at least one of `start`, `stop`, `step` to a</span>
<span class="sd">            non-default value will raise a :exc:`ValueError`.</span>
<span class="sd">            .. versionadded:: 2.2.0</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Turn on verbosity</span>
<span class="sd">        n_jobs : int, optional</span>
<span class="sd">            number of jobs to start, if `-1` use number of logical cpu cores.</span>
<span class="sd">            This argument will be ignored when the distributed scheduler is</span>
<span class="sd">            used</span>
<span class="sd">            .. versionadded:: PERSONAL-COPY</span>
<span class="sd">        module : str, optional</span>
<span class="sd">            Parallelization module to use. Default: ``&quot;multiprocessing&quot;``.</span>
<span class="sd">            .. versionadded:: PERSONAL-COPY</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Parallelization method to use. This is the Dask scheduler,</span>
<span class="sd">            Joblib backend, or the multiprocessing method. Default: ``None``.</span>
<span class="sd">            .. versionadded:: PERSONAL-COPY</span>
<span class="sd">        n_blocks : int, optional</span>
<span class="sd">            number of blocks to divide trajectory into. If ``None`` set equal</span>
<span class="sd">            to n_jobs or number of available workers in scheduler.</span>
<span class="sd">            .. versionadded:: PERSONAL-COPY</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Other keyword arguments passed to :func:`dask.base.compute`.</span>
<span class="sd">        .. versionchanged:: 2.2.0</span>
<span class="sd">            Added ability to analyze arbitrary frames by passing a list of</span>
<span class="sd">            frame indices in the `frames` keyword argument.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : :class:`ParallelAnalysisBase` instance</span>
<span class="sd">            The instance itself.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If `frames` is used in conjunction with `start`, `stop`, or `step`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting run method&quot;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_verbose&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_frames</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_atomgroups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">universe</span><span class="o">.</span><span class="n">trajectory</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
            <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
            <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">()</span>

        <span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">n_blocks</span> <span class="o">=</span> <span class="n">n_blocks</span> <span class="k">if</span> <span class="n">n_blocks</span> <span class="k">else</span> <span class="n">n_jobs</span>
        <span class="n">ts_indices</span> <span class="o">=</span> <span class="n">frames</span> <span class="k">if</span> <span class="n">frames</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
        <span class="n">block_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">ts_indices</span><span class="p">,</span> <span class="n">n_blocks</span><span class="p">)</span>

        <span class="c1"># issue errors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;run() analyses no frames: check start/stop/step&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">&lt;</span> <span class="n">n_blocks</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;run() uses more blocks than frames: &quot;</span> <span class="s2">&quot;decrease n_blocks&quot;</span><span class="p">)</span>

        <span class="c1"># dask scheduler</span>
        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span> <span class="ow">and</span> <span class="n">FOUND_DASK</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">get_client</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
                <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;scheduler&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_worker_logs</span><span class="p">()),</span> <span class="n">n_jobs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;processes&quot;</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="s2">&quot;distributed&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;processes&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;threading&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;threads&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;single-threaded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sync&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;synchronous&quot;</span><span class="p">,</span>
                <span class="p">}:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid Dask scheduler.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;distributed&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;The Dask distributed client &quot;</span>
                        <span class="s2">&quot;(client = dask.distributed.Client(...)) &quot;</span>
                        <span class="s2">&quot;should be instantiated in the main &quot;</span>
                        <span class="s2">&quot;program (__name__ = &#39;__main__&#39;) of &quot;</span>
                        <span class="s2">&quot;your script.&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
                <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;threading&quot;</span><span class="p">,</span> <span class="s2">&quot;threads&quot;</span><span class="p">}:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;The threaded Dask scheduler is not &quot;</span>
                        <span class="s2">&quot;compatible with MDAnalysis.&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
                <span class="k">elif</span> <span class="n">n_jobs</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="s2">&quot;single-threaded&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sync&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;synchronous&quot;</span><span class="p">,</span>
                <span class="p">}:</span>
                    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;synchronous&quot;</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Since </span><span class="si">{</span><span class="n">n_jobs</span><span class="si">=}</span><span class="s2">, the synchronous &quot;</span>
                        <span class="s2">&quot;Dask scheduler will be used instead.&quot;</span>
                    <span class="p">)</span>
                <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span> <span class="o">|</span> <span class="n">kwargs</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;processes&quot;</span><span class="p">:</span>
                    <span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_jobs</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Starting analysis using Dask (</span><span class="si">{</span><span class="n">n_jobs</span><span class="si">=}</span><span class="s2">, &quot;</span>
                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;scheduler=</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)...&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">block_indices</span><span class="p">:</span>
                <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_block</span><span class="p">)(</span><span class="n">indices</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">time_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">blocks</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
            <span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">block_results</span> <span class="o">=</span> <span class="n">blocks</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># joblib backend</span>
        <span class="k">elif</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;joblib&quot;</span> <span class="ow">and</span> <span class="n">FOUND_JOBLIB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;processes&quot;</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;processes&quot;</span><span class="p">,</span> <span class="s2">&quot;threads&quot;</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid Joblib backend.&quot;</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Starting analysis using Joblib (</span><span class="si">{</span><span class="n">n_jobs</span><span class="si">=}</span><span class="s2">, backend=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">)...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">time_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="n">block_results</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span>
                <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
                <span class="n">prefer</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="p">)(</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_block</span><span class="p">)(</span><span class="n">indices</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="n">block_indices</span><span class="p">,</span>
                    <span class="n">total</span><span class="o">=</span><span class="n">n_blocks</span><span class="p">,</span>
                    <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;block&quot;</span><span class="p">,</span>
                    <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analysis&quot;</span><span class="p">,</span>
                    <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># multiprocessing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="o">!=</span> <span class="s2">&quot;multiprocessing&quot;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The Dask or Joblib library was not &quot;</span>
                    <span class="s2">&quot;found, so the native multiprocessing &quot;</span>
                    <span class="s2">&quot;module will be used instead.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_start_method</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;fork&quot;</span><span class="p">,</span> <span class="s2">&quot;forkserver&quot;</span><span class="p">,</span> <span class="s2">&quot;spawn&quot;</span><span class="p">}:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid multiprocessing start method.&quot;</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Starting analysis using multiprocessing (</span><span class="si">{</span><span class="n">n_jobs</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">method</span><span class="si">=}</span><span class="s2">)...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">time_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">block_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">tqdm</span><span class="p">(</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_job_block</span><span class="p">),</span> <span class="n">block_indices</span><span class="p">),</span>
                        <span class="n">total</span><span class="o">=</span><span class="n">n_blocks</span><span class="p">,</span>
                        <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;block&quot;</span><span class="p">,</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Analysis&quot;</span><span class="p">,</span>
                        <span class="n">mininterval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># combine results</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">block_results</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No results returned.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished! Time elapsed: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">time_start</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># create dataframe</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No columns specified. Not creating dataframe.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tag</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Could not create dataframe. Results have wrong shape.&quot;</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not create dataframe. Results have wrong shape.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># conclude and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conclude</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase.merge_external_data"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase.merge_external_data">[docs]</a>    <span class="k">def</span> <span class="nf">merge_external_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge external data with the results of the analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            Dataframe containing the data to merge</span>
<span class="sd">        col : str, optional</span>
<span class="sd">            Column name to merge on, by default &quot;time&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Dataframe with merged data</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no results are present</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no data is merged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No results present. Cannot merge data.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">)</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_out</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not merge dataframes. No data merged.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_out</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">nrows</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_out</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows of data merged. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s2"> rows.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df_out</span>
        <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase._job_block"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase._job_block">[docs]</a>    <span class="k">def</span> <span class="nf">_job_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absolute_frame_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to actually setup the Dask tasks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        absolute_frame_indices : np.array</span>
<span class="sd">            Array of frame indices to analyze. These indices are absolute</span>
<span class="sd">            and refer to frame numbers in the trajectory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array</span>
<span class="sd">            Array of results from the analysis of the frames</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">absolute_frame_indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ab</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">absolute_frame_indices</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">ab</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_frame</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># find maximum number of elements in the list</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># return 2D array if each frame returns a 1D array</span>
        <span class="k">if</span> <span class="n">max_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase._reduce"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase._reduce">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reduce</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">result_single_frame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&#39;append&#39; action for a time series&quot;&quot;&quot;</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_single_frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase._conclude"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase._conclude">[docs]</a>    <span class="k">def</span> <span class="nf">_conclude</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize the results of the calculation. This is called once</span>
<span class="sd">        after the analysis is finished inside the run() method. The method</span>
<span class="sd">        concatenates the results from the single frame analysis and</span>
<span class="sd">        input weights dataframe, if provided.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no results are found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ParallelAnalysisBase.save"><a class="viewcode-back" href="../../colvar_parallel.base.html#colvar_parallel.base.ParallelAnalysisBase.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_out</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the results of the analysis to a parquet file. The results</span>
<span class="sd">        are saved to the `data` directory in the `dir_out` directory.</span>

<span class="sd">        This method should only be called after the analysis has been</span>
<span class="sd">        run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dir_out : str, optional</span>
<span class="sd">            The directory to save the results to. If not specified, the</span>
<span class="sd">            results are saved to the directory specified in the</span>
<span class="sd">            `dir_out` attribute.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no dataframe is found.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no filename is found.</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no output directory is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No dataframe found. Did you run the analysis?&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Did the child class set the `columns` &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;attribute?&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No filename found. Did the child class &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;set the `df_filename` attribute?&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No output directory specified. Please specify a directory &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;in the `dir_out` attribute or as an argument to the &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;save() method.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">dir_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dir_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dir_out</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">dir_out</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Saving </span><span class="si">{</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> analysis for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_tag</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dir_out</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">dir_out</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_filename</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Alec Glisman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>